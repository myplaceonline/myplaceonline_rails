# https://docs.travis-ci.com/user/job-lifecycle
# Ubuntu Xenial 16.04 is needed for the latest version of ImageMagick
dist: xenial
language: ruby
sudo: false

# https://docs.travis-ci.com/user/languages/ruby/
rvm:
  - 2.3

before_script:
  - cp config/database.yml.travis config/database.yml

before_install:
  - sudo apt-get install -y imagemagick libmagickwand-dev libmagic-dev
  
addons:
  apt:
    update: true

# "If before_install, install or before_script returns a non-zero exit code, the build is errored and stops immediately."
# This means failure during install don't allow us to do post-mortem;
# instead, we perform the install manually in the script.
install: true

script:
  - bundle install --deployment
  - RAILS_ENV=test SKIP_LARGE_UNNEEDED_IMPORTS=true SKIP_ZIP_CODE_IMPORTS=true travis_wait 120 bundle exec rake db:test:prepare test

after_failure:
  - cat /home/travis/build/myplaceonline/myplaceonline_rails/vendor/bundle/ruby/2.3.0/extensions/x86_64-linux/2.3.0/ruby-filemagic-0.7.2/mkmf.log
